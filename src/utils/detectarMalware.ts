// utils/detectarMalware.ts

interface AmeaçaDetectada {
  alerta: string;
  trecho: string;
  origem: string;
  sugestao: string;
}

export function detectarMalwareDetalhado(html: string): AmeaçaDetectada[] {
  const ameaças: AmeaçaDetectada[] = [];

  const regras = [
    {
      alerta: "Uso de função JavaScript potencialmente perigosa",
      padrao:
        /<script[^>]*>.*?(eval|atob|Function|setTimeout)\([^<]*<\/script>/gis,
      sugestao:
        "Evite o uso de 'eval', 'atob' ou 'Function' — substitua por lógica segura.",
      origem: "inline",
    },
    {
      alerta: "Código de redirecionamento detectado",
      padrao:
        /window\.location\s*=\s*['"][^'"]+['"]|document\.location|top\.location/gi,
      sugestao:
        "Evite redirecionamentos diretos via JavaScript — faça no servidor.",
      origem: "inline",
    },
    {
      alerta: "Iframe oculto detectado",
      padrao:
        /<iframe[^>]*(display\s*:\s*none|width\s*=\s*["']?0["']?|height\s*=\s*["']?0["']?)[^>]*>/gi,
      sugestao: "Remova iframes ocultos ou verifique sua origem.",
      origem: "iframe",
    },
    {
      alerta: "Script externo suspeito detectado",
      padrao:
        /<script[^>]*src=['"](https?:\/\/[^'"]*(malware|track|spy|ads|click))[^'"]*['"][^>]*><\/script>/gi,
      sugestao: "Evite scripts de domínios suspeitos ou desconhecidos.",
      origem: "externo",
    },
    {
      alerta: "Plugin WordPress suspeito identificado",
      padrao: /wp-content\/(plugins|themes)\/(\w+)[^"']*/gi,
      sugestao:
        "Analise o plugin indicado e verifique se está atualizado ou comprometido.",
      origem: "WordPress",
    },
  ];

  for (const regra of regras) {
    const encontrados = html.match(regra.padrao);
    if (encontrados) {
      encontrados.forEach((trecho) => {
        ameaças.push({
          alerta: regra.alerta,
          trecho: trecho.trim().substring(0, 500), // limita tamanho
          origem: regra.origem,
          sugestao: regra.sugestao,
        });
      });
    }
  }

  return ameaças;
}
